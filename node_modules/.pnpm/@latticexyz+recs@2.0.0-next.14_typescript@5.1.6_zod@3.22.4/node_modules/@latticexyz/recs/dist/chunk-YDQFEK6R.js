var P=(o=>(o[o.Boolean=0]="Boolean",o[o.Number=1]="Number",o[o.OptionalNumber=2]="OptionalNumber",o[o.BigInt=3]="BigInt",o[o.OptionalBigInt=4]="OptionalBigInt",o[o.String=5]="String",o[o.OptionalString=6]="OptionalString",o[o.NumberArray=7]="NumberArray",o[o.OptionalNumberArray=8]="OptionalNumberArray",o[o.BigIntArray=9]="BigIntArray",o[o.OptionalBigIntArray=10]="OptionalBigIntArray",o[o.StringArray=11]="StringArray",o[o.OptionalStringArray=12]="OptionalStringArray",o[o.Entity=13]="Entity",o[o.OptionalEntity=14]="OptionalEntity",o[o.EntityArray=15]="EntityArray",o[o.OptionalEntityArray=16]="OptionalEntityArray",o[o.T=17]="T",o[o.OptionalT=18]="OptionalT",o))(P||{}),k=(i=>(i[i.Enter=0]="Enter",i[i.Exit=1]="Exit",i[i.Update=2]="Update",i[i.Noop=3]="Noop",i))(k||{}),w=[14,16,2,8,4,10,6,12,18];import{transformIterator as j,uuid as F}from"@latticexyz/utils";import{mapObject as N}from"@latticexyz/utils";import{filter as L,map as D,Subject as $}from"rxjs";function M(e){let t=new Map;function n(l){let u=t.get(r(l));return u?new Set([...u].map(v)):new Set}function r(l){return Object.values(l).join("/")}function i(l,u){if(!u)return;let x=r(u),f=t.get(x);f||(f=new Set,t.set(x,f)),f.add(l)}function d(l,u){if(!u)return;let x=r(u),f=t.get(x);f&&f.delete(l)}for(let l of V(e)){let u=g(e,l);i(p(l),u)}let m=e.update$.subscribe(({entity:l,value:u})=>{d(p(l),u[1]),i(p(l),u[0])});return e.world.registerDisposer(()=>m?.unsubscribe()),{...e,getEntitiesWithValue:n}}import{map as W,pipe as B}from"rxjs";function X(e,t){return e.component===t}function U(e,t){let n=g(t,e);return{entity:e,component:t,value:[n,void 0],type:n==null?3:0}}function Y(e){return B(W(t=>U(t,e)))}function I(e){return"getEntitiesWithValue"in e}function T(e,t){return Object.keys(e.schema).every(n=>n in t)}function b(e){return e.metadata?.componentName??e.metadata?.tableName??e.metadata?.tableId??e.metadata?.contractId??e.id}function ie(e,t,n){if(Object.keys(t).length===0)throw new Error("Component schema must have at least one key");let r=n?.id??F(),i=N(t,()=>new Map),d=new $,m=n?.metadata,u={values:i,schema:t,id:r,update$:d,metadata:m,entities:()=>j(Object.values(i)[0].keys(),v),world:e};return n?.indexed&&(u=M(u)),e.registerComponent(u),u}function E(e,t,n,r={}){let i=p(t),d=g(e,t);for(let[m,l]of Object.entries(n))e.values[m]?e.values[m].set(i,l):e.metadata?.tableId&&/^\d+$/.test(m)||console.warn("Component definition for",b(e),"is missing key",m,", ignoring value",l,"for entity",t,". Existing keys: ",Object.keys(e.values));r.skipUpdateStream||e.update$.next({entity:t,value:[n,d],component:e})}function se(e,t,n,r,i={}){let d=g(e,t);if(d===void 0){if(r===void 0)throw new Error(`Can't update component ${b(e)} without a current value or initial value`);E(e,t,{...r,...n},i)}else E(e,t,{...d,...n},i)}function ue(e,t,n={}){let r=p(t),i=g(e,t);for(let d of Object.keys(e.values))e.values[d].delete(r);n.skipUpdateStream||e.update$.next({entity:t,value:[void 0,i],component:e})}function le(e,t){let n=p(t);return Object.values(e.values)[0].has(n)}function g(e,t){let n={},r=p(t),i=Object.keys(e.schema);for(let d of i){let m=e.values[d].get(r);if(m===void 0&&!w.includes(e.schema[d]))return;n[d]=m}return n}function de(e,t){let n=g(e,t);if(!n)throw new Error(`No value for component ${b(e)} on entity ${t}`);return n}function K(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;let n=!0;for(let r of Object.keys(e))if(n=e[r]===t[r],!n)return!1;return n}function me(e,t){return[e,t]}function ce(e,t){if(I(e)&&T(e,t))return e.getEntitiesWithValue(t);let n=new Set;for(let r of V(e)){let i=g(e,r);K(t,i)&&n.add(r)}return n}function V(e){return e.entities()}function Se(e){let t=0,n=new Map,r=new Map,i=new $;function d(s,a){n.set(s,{update:a,nonce:t++}),C(a.entity,a.value)}function m(s){let a=n.get(s)?.update.entity;if(n.delete(s),a==null)return;let S=[...n.values()].filter(c=>c.update.entity===a).sort((c,h)=>c.nonce<h.nonce?-1:1);if(S.length>0){let c=S[S.length-1];C(a,c.update.value)}else C(a,void 0)}function l(s){let a=g(e,s),S=p(s),c=r.get(S);return(a||c)&&c!==null?{...a,...c}:void 0}let u=s=>({get(a,S){return S==="get"?c=>{let h=a.get(c),O=r.get(c);return O&&O[s]!=null?O[s]:h}:S==="has"?c=>a.has(c)||r.has(c):S==="keys"?()=>new Set([...a.keys(),...r.keys()]).values():Reflect.get(a,S,a)}}),x={};for(let s of Object.keys(e.values))x[s]=new Proxy(e.values[s],u(s));let f=x,y=new Proxy(e,{get(s,a){return a==="addOverride"?d:a==="removeOverride"?m:a==="values"?f:a==="update$"?i:a==="entities"?()=>new Set([...j(r.keys(),v),...s.entities()]).values():Reflect.get(s,a)},has(s,a){return a==="addOverride"||a==="removeOverride"?!0:a in s}});function C(s,a){let S=p(s),c=l(s);a!==void 0?r.set(S,a):r.delete(S),i.next({entity:s,value:[l(s),c],component:y})}return e.update$.pipe(L(s=>!r.get(p(s.entity))),D(s=>({...s,component:y}))).subscribe(i),y}function A(e,t){return`localcache-${t}-${e.id}`}function fe(e,t){localStorage.removeItem(A(e,t))}function pe(e,t){let{world:n,update$:r,values:i}=e,d=A(e,t),m=0,l=Date.now(),u=localStorage.getItem(d);if(u){let f=JSON.parse(u),y={};for(let[C,s]of f)for(let[a,S]of s)y[a]=y[a]||{},y[a][C]=S;for(let[C,s]of Object.entries(y)){let a=n.registerEntity({id:C});E(e,a,s)}console.info("Loading component",b(e),"from local cache.")}let x=r.subscribe(()=>{m++;let f=JSON.stringify(Object.entries(N(i,y=>[...y.entries()].map(C=>[v(C[0]),C[1]]))));localStorage.setItem(d,f),m>200&&console.warn("Component",b(e),"was locally cached",m,"times since",new Date(l).toLocaleTimeString(),"- the local cache is in an alpha state and should not be used with components that update frequently yet")});return e.world.registerDisposer(()=>x?.unsubscribe()),e}function ge(e,t,n){let r=e.registerEntity(n??{});if(t)for(let[i,d]of t)E(i,r,d);return r}function p(e){return Symbol.for(e)}function v(e){return Symbol.keyFor(e)}export{P as a,k as b,w as c,ge as d,p as e,v as f,M as g,X as h,U as i,Y as j,I as k,T as l,ie as m,E as n,se as o,ue as p,le as q,g as r,de as s,K as t,me as u,ce as v,V as w,Se as x,fe as y,pe as z};
//# sourceMappingURL=chunk-YDQFEK6R.js.map